<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <title>three.js webgl - loaders - MMD loader</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <style>
    body {
        font-family: "Microsoft YaHei" ! important;
        background-color: #fff;
        color: #000;
        margin: 0px;
        overflow: hidden;
    }

    #info {
        color: #000;
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        display: block;
    }

    #info a,
    .button {
        color: #f00;
        font-weight: bold;
        text-decoration: underline;
        cursor: pointer
    }
    #hover {
    	background-color: #DDE0DF;
    	position: absolute;
    	top: 0px;
    	left: 0px;
    	height: 100%;
    	width: 100%;
    }
    .hover {
    	display: inline;
    }
    .innertext {
    	position: relative;
    	top: 30%;
    	left: 45%;
    }
    #text {
    }
    </style>
    </head>

<body>
	<div id = "hover" class = "in-text">
		<span class="innertext"><span><h3 id="text"> Loading</h3></span></span>
	</div>

    <script src="js/build/three.js"></script>
    <script src="js/build/mmdparsers.js"></script>
    <script src="js/libs/ammo.js"></script>
    <script src="js/loaders/TGALoader.js"></script>
    <script src="js/loaders/MMDLoader.js"></script>
    <script src="js/effects/OutlineEffect.js"></script>
    <script src="js/animation/CCDIKSolver.js"></script>
    <script src="js/animation/MMDPhysics.js"></script>
    <script src="js/controls/OrbitControls.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/libs/stats.min.js"></script>
    <script src="js/libs/dat.gui.min.js"></script>
    <script type="text/javascript">
    var container, stats;
    var mesh, camera, scene, renderer, effect;
    var helper, ikHelper, physicsHelper;
    var mouseX = 0,
        mouseY = 0;
    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;
    var clock = new THREE.Clock();
    var modelFile;//模型文件
    var vmdFiles;//动作文件
    var audioFiles;//声音文件
    //var hover;//加载遮罩层
    var onLoadPresent;//全局加载进度
    //hover = document.body.appendChild('hover');
    //hover.setAttribute('id', 'hover');
    modelFile = 'model/kizunaai/kizunaai.pmx';
    vmdFiles = ['vmd/youjiannodie.vmd'];
    audioFiles = 'audio/youjiannodie.mp3';
    init();
    animate();

    //rerender();

    function init() {
        //创建场景和隐藏的audio标签
        hover = document.createElement('div');
        loader = document.createElement('span');
        hover.setAttribute('id', 'hover');

        container = document.createElement('div');
        container.setAttribute('id', 'mmd');
        audioplayer = document.createElement('audio');
        audioplayer.setAttribute('id', 'player');
        audioplayer.style.display = "none";
        audioplayer.style.display = "inline";
        document.body.appendChild(audioplayer);
        document.body.appendChild(container);
        audioplayer.src = audioFiles;
        //画面初始化
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.z = 30;
        // 视角
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        var gridHelper = new THREE.PolarGridHelper(30, 10);
        gridHelper.position.y = -10;
        //scene.add( gridHelper );//地面
        var ambient = new THREE.AmbientLight(0x666666);
        scene.add(ambient);
        var directionalLight = new THREE.DirectionalLight(0x887766);
        directionalLight.position.set(-1, 1, 1).normalize();
        scene.add(directionalLight);
        //
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth / 1, window.innerHeight / 1);
        container.appendChild(renderer.domElement);
        effect = new THREE.OutlineEffect(renderer);
        // STATS
        stats = new Stats();
        //container.appendChild( stats.dom );//左上角帧数监视器
        // model
        var onProgress = function(xhr) {
            if (xhr.lengthComputable) {
                var percentComplete = xhr.loaded / xhr.total * 100;
                //onLoadPersent = Math.round(percentComplete, 2);
                if (percentComplete == 100) {
                	onLoadComplete();
                }
                onLoadPersent(percentComplete);
            }
        };
        var onError = function(xhr) {};
        //var modelFile = 'models/mmd/kizunaai/kizunaai.pmx';
        //var vmdFiles = ['models/mmd/vmds/小苹果 单人.vmd'];
        helper = new THREE.MMDHelper();
        var loader = new THREE.MMDLoader();
        loader.load(modelFile, vmdFiles, function(object) {
            mesh = object;
            mesh.position.y = -10;
            scene.add(mesh);
            helper.add(mesh);
            helper.setAnimation(mesh);
            /*
             * Note: create CCDIKHelper after calling helper.setAnimation()
             */
            ikHelper = new THREE.CCDIKHelper(mesh);
            ikHelper.visible = false;
            scene.add(ikHelper);
            /*
             * Note: You're recommended to call helper.setPhysics()
             *       after calling helper.setAnimation().
             */
            helper.setPhysics(mesh);
            physicsHelper = new THREE.MMDPhysicsHelper(mesh);
            physicsHelper.visible = false;
            scene.add(physicsHelper);
            helper.unifyAnimationDuration({ afterglow: 2.0 });
            //initGui();//删除右上角控制
        }, onProgress, onError);
        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        window.addEventListener('resize', onWindowResize, false);
        var phongMaterials;
        var originalMaterials;

        function makePhongMaterials(materials) {
            var array = [];
            for (var i = 0, il = materials.length; i < il; i++) {
                var m = new THREE.MeshPhongMaterial();
                m.copy(materials[i]);
                m.needsUpdate = true;
                array.push(m);
            }
            phongMaterials = array;
        }
        /**function initGui () {
        	var api = {
        		'animation': false,
        		'gradient mapping': true,
        		'ik': true,
        		'outline': true,
        		'physics': true,
        		'show IK bones': false,
        		'show rigid bodies': false
        	};
        	var gui = new dat.GUI();
        	gui.add( api, 'animation' ).onChange( function () {
        		helper.doAnimation = api[ 'animation' ];
        	} );
        	gui.add( api, 'gradient mapping' ).onChange( function () {
        		if ( originalMaterials === undefined ) originalMaterials = mesh.material;
        		if ( phongMaterials === undefined ) makePhongMaterials( mesh.material );
        		if ( api[ 'gradient mapping' ] ) {
        			mesh.material = originalMaterials;
        		} else {
        			mesh.material = phongMaterials;
        		}
        	} );
        	gui.add( api, 'ik' ).onChange( function () {
        		helper.doIk = api[ 'ik' ];
        	} );
        	gui.add( api, 'outline' ).onChange( function () {
        		//effect.enabled = api[ 'outline' ];
        	} );
        	gui.add( api, 'physics' ).onChange( function () {
        		helper.enablePhysics( api[ 'physics' ] );
        	} );
        	gui.add( api, 'show IK bones' ).onChange( function () {
        		ikHelper.visible = api[ 'show IK bones' ];
        	} );
        	gui.add( api, 'show rigid bodies' ).onChange( function () {
        		if ( physicsHelper !== undefined ) physicsHelper.visible = api[ 'show rigid bodies' ];
        	} );
        }**/
    }

    function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        effect.setSize(window.innerWidth / 1, window.innerHeight / 1);
    }
    //
    function animate() {
        requestAnimationFrame(animate);
        stats.begin();
        render();
        stats.end();
    }

    function render() {
        helper.animate(clock.getDelta());
        if (physicsHelper !== undefined && physicsHelper.visible) physicsHelper.update();
        if (ikHelper !== undefined && ikHelper.visible) ikHelper.update();
        effect.render(scene, camera);
    }

    function rerender() {
    	//重播先删除再重建画面和音乐播放器
    	var mmd = document.getElementById('mmd');
    	var audio = document.getElementById('player');
    	audio.stop();
    	document.body.removeChild('mmd');
    	document.body.removeChild('audio');
    	init();
    	animate();
    }
    /**function start() {
    
    }**/
    function onLoadComplete() {
    	document.body.removeChild(document.getElementById('hover'));
    	var audioplayer = document.getElementById('player');
    	//audioplayer.play();
    	setTimeout("audioplayer.play()",1000);
    }
    function onLoadPersent(persent) {
    }
    </script>
</body>

</html>